#!/usr/bin/env bash

set -euo pipefail

here=$(cd "$(dirname "$BASH_SOURCE")"; pwd)
source "$here/env.bash"
core_root="$PROJECT_ROOT"/core

(
    cd "$core_root"

    target=${1:-debug}
    if [[ $target == "release" ]]; then
        extra="--release"
    else
        extra=""
    fi

    cargo build --all $extra

    module_dir="$core_root/target/$target"
    cp -f "$module_dir/$MODULE_ORIGINAL" "./$MODULE_RENAMED"
    cargo pkgid | cut -d# -f2 | cut -d: -f2 | tr -d $'\n' > ./DYN-VERSION

    cask build
)

(
    cd "$PROJECT_ROOT"
    cask build
)
